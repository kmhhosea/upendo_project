<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upendo - Donors & Needs</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
  <div id="app">
    <header class="topbar">
      <h1>Upendo</h1>
      <p class="tag">Connecting donors with children and families who need help</p>
    </header>

    <main class="container">
      <section class="left-panel">
        <div class="controls">
          <button id="refreshBtn">Refresh Needs</button>
          <button id="showCreateNeed">Post a Need</button>
        </div>
        <div id="needsList" class="needs-list">
          <!-- dynamic needs inserted here -->
        </div>
      </section>

      <section class="right-panel">
        <div id="needDetail" class="need-detail empty">
          <p>Select a need to view details and donate.</p>
        </div>
      </section>
    </main>

    <footer class="footer">
      <small>Upendo — build compassion into your community</small>
    </footer>
  </div>

  <!-- Modal for creating a need -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <button id="closeModal" class="modal-close">&times;</button>
      <h2>Post a new Need</h2>
      <form id="createNeedForm">
        <label>Title<input name="title" required /></label>
        <label>Amount Needed (TZS or USD)<input name="amount_needed" type="number" step="0.01" required /></label>
        <label>Contact<input name="contact" /></label>
        <label>Image URL<input name="image_url" /></label>
        <label>Description<textarea name="description"></textarea></label>
        <button type="submit">Create Need</button>
      </form>
    </div>
  </div>

  <script>
  // Single-file SPA JavaScript: fetch API to talk to Django endpoints
  (function(){
    const apiBase = '/api/';

    // helper: get CSRF token from cookie
    function getCookie(name) {
      const matches = document.cookie.match(new RegExp(
        '(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'
      ));
      return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    const csrfToken = getCookie('csrftoken');

    // DOM nodes
    const needsList = document.getElementById('needsList');
    const needDetail = document.getElementById('needDetail');
    const refreshBtn = document.getElementById('refreshBtn');
    const showCreateNeed = document.getElementById('showCreateNeed');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const createNeedForm = document.getElementById('createNeedForm');

    // load needs data and render
    async function loadNeeds(){
      try{
        const res = await fetch(apiBase + 'needs/');
        const j = await res.json();
        renderNeeds(j.needs || []);
      }catch(err){
        console.error('Failed to load needs', err);
      }
    }

    function renderNeeds(needs){
      needsList.innerHTML = '';
      if(needs.length === 0){
        needsList.innerHTML = '<p class="muted">No active needs yet.</p>';
        return;
      }

      needs.forEach(n => {
        const el = document.createElement('div');
        el.className = 'need-card';
        el.innerHTML = `
          <h3>${escapeHtml(n.title)}</h3>
          <p class="small">${escapeHtml(n.description)}</p>
          <p class="meta">Needed: ${n.amount_needed} — Received: ${n.amount_received}</p>
          <button data-id="${n.id}" class="viewBtn">View & Donate</button>
        `;
        needsList.appendChild(el);
      });

      // wire up view buttons
      document.querySelectorAll('.viewBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          showNeedDetail(id);
        });
      });
    }

    // simple HTML escaper
    function escapeHtml(str){
      if(!str) return '';
      return str.replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[s]);
    }

    // show detail view for a need
    async function showNeedDetail(id){
      needDetail.classList.remove('empty');
      needDetail.innerHTML = '<p>Loading...</p>';
      try{
        const res = await fetch(apiBase + 'needs/' + id + '/');
        const n = await res.json();
        needDetail.innerHTML = `
          <h2>${escapeHtml(n.title)}</h2>
          <p>${escapeHtml(n.description)}</p>
          <p class="meta">Needed: ${n.amount_needed} — Received: ${n.amount_received}</p>
          <p>Contact: ${escapeHtml(n.contact || 'Not provided')}</p>

          <hr/>
          <h3>Donate</h3>
          <form id="donationForm">
            <label>Your name <input name="donor_name" /></label>
            <label>Amount <input name="amount" type="number" step="0.01" required /></label>
            <label>Message <input name="message" /></label>
            <button type="submit">Give</button>
          </form>

          <h3>Recent donations</h3>
          <div id="donationsList"></div>
        `;

        // render donations
        const donationsList = document.getElementById('donationsList');
        donationsList.innerHTML = '';
        (n.donations || []).forEach(d => {
          const dEl = document.createElement('div');
          dEl.className = 'donation-item';
          dEl.innerHTML = `<strong>${escapeHtml(d.donor_name)}</strong> gave ${d.amount} <div class="small">${escapeHtml(d.message)}</div>`;
          donationsList.appendChild(dEl);
        });

        // wire donation form
        const donationForm = document.getElementById('donationForm');
        donationForm.addEventListener('submit', async e => {
          e.preventDefault();
          const formData = new FormData(donationForm);
          const payload = {
            donor_name: formData.get('donor_name') || 'Anonymous',
            amount: parseFloat(formData.get('amount')) || 0,
            message: formData.get('message') || '',
          };

          // optimistic UI: disable button
          const btn = donationForm.querySelector('button[type="submit"]');
          btn.disabled = true;
          btn.textContent = 'Processing...';

          try{
            const r = await fetch(apiBase + 'needs/' + id + '/donate/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
              },
              body: JSON.stringify(payload)
            });
            if(!r.ok) throw new Error('Donation failed');
            const j = await r.json();
            // update amount displayed
            const meta = needDetail.querySelector('.meta');
            meta.textContent = `Needed: ${n.amount_needed} — Received: ${j.new_amount_received}`;
            // prepend donation to list
            const dEl = document.createElement('div');
            dEl.className = 'donation-item';
            dEl.innerHTML = `<strong>${escapeHtml(payload.donor_name)}</strong> gave ${payload.amount} <div class="small">${escapeHtml(payload.message)}</div>`;
            donationsList.insertBefore(dEl, donationsList.firstChild);
            // reset
            donationForm.reset();
            alert('Thank you for your contribution! (Simulated)');
          }catch(err){
            console.error(err);
            alert('Donation failed: ' + (err.message || 'Unknown'));
          }finally{
            btn.disabled = false;
            btn.textContent = 'Give';
          }
        });

      }catch(err){
        console.error(err);
        needDetail.innerHTML = '<p>Unable to load need.</p>';
      }
    }

    // Modal behaviour
    showCreateNeed.addEventListener('click', () => modal.classList.remove('hidden'));
    closeModal.addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', e => {
      if(e.target === modal) modal.classList.add('hidden');
    });

    createNeedForm.addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(createNeedForm);
      const payload = {
        title: fd.get('title'),
        amount_needed: parseFloat(fd.get('amount_needed')) || 0,
        contact: fd.get('contact'),
        image_url: fd.get('image_url'),
        description: fd.get('description')
      };

      try{
        const r = await fetch(apiBase + 'needs/create/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken || ''},
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error('Create failed');
        await r.json();
        modal.classList.add('hidden');
        createNeedForm.reset();
        loadNeeds();
        alert('Need created!');
      }catch(err){
        console.error(err);
        alert('Failed to create need: ' + (err.message || 'Unknown'));
      }

    });

    refreshBtn.addEventListener('click', loadNeeds);

    // initial load
    loadNeeds();

    // periodic refresh every 25 seconds for 'real-time' feel
    setInterval(loadNeeds, 25000);

  })();
  </script>
</body>
</html>
